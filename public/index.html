<html>
	<head>
		<title>orbit</title>
		<script>
			var requestAnimFrame = (function(){
			      return  window.requestAnimationFrame       || 
			              window.webkitRequestAnimationFrame || 
			              window.mozRequestAnimationFrame    || 
			              window.oRequestAnimationFrame      || 
			              window.msRequestAnimationFrame     || 
			              function(callback) {
			              		window.setTimeout(callback, 1000 / 60);
			              };
			})();

			// Array Remove - By John Resig (MIT Licensed)
			Array.prototype.remove = function(from, to) {
				var rest = this.slice((to || from) + 1 || this.length);
				this.length = from < 0 ? this.length + from : from;
				return this.push.apply(this, rest);
			};

			var GameState = {
				ORBIT_PLACING : 1,
				ORBIT_WINDUP : 2,
				ORBIT_ACTIVE : 3,
				ORBIT_FINISHED : 4
			};

			// Game variables.
			var gameState;
			var mousePos;
			var mouseDownPos;
			var maxLength;
			var maxDistance;
			var iterations;
			var releasePos;

			// Initialize the game objects.
			var thrownObject;
			var thrownObjects;

			var planet = {
				radius : 50,
				pos : [ 0, 0 ],
				img : null
			};

			function drawOrbitPosition(context, pos, radius) {
				context.fillStyle = "#dddddd";
				context.strokeStyle = "#ffffff";

				context.beginPath();
				context.arc(pos[0], pos[1], radius, 0, 2 * Math.PI, false);
				context.fill();
				context.stroke();
			}

			function length(vec) {
				return Math.sqrt(vec[0] * vec[0] + vec[1] * vec[1]);
			}

			function distance(vec1, vec2) {
				var x = vec2[0] - vec1[0];
				var y = vec2[1] - vec1[1];
				return length([x, y]);
			}
			function normalize(vec) {
				var len = length(vec);
				return [ vec[0] / len, vec[1] / len ];
			}

			function direction(vec1, vec2) {
				var x = vec2[0] - vec1[0];
				var y = vec2[1] - vec1[1];
				return normalize([ x, y ]);
			}

			function update() {
				if (gameState == GameState.ORBIT_PLACING) {
					thrownObject.pos = mousePos;
				}
				else if (gameState == GameState.ORBIT_WINDUP) {
					thrownObject.pos = mouseDownPos;
				}

				for (var i = 0; i < thrownObjects.length; ++i) {
					var obj = thrownObjects[i];

					var curPos = obj.pos;
					var curVel = obj.vel;
					var planetPos = planet.pos;

					var prevDir = direction(planetPos, curPos);

					var dist = distance(curPos, planetPos);
					var dir = direction(curPos, planetPos);
					var force = 3000.0 / ((dist * dist) + 500.0);

					if (dist > maxDistance) {
						thrownObjects = [];
					}

					curVel[0] += dir[0] * force;
					curVel[1] += dir[1] * force;

					curPos[0] += curVel[0];
					curPos[1] += curVel[1];

					// Cheat here a little bit to make the mechanics more interesting.
					// Basically, dampen the velocity away from the planet.
					// This forces the orbit into a spiral, but avoids the ease of putting the object into
					// an elliptical orbit, rewarding more circular orbits.
					var velDir = normalize(curVel);
					var otherDir = direction(planetPos, curPos);
					var dampenFactor = Math.max(velDir[0] * otherDir[0] + velDir[1] * otherDir[1], 0) * 0.05;
					curVel[0] = curVel[0] - curVel[0] * dampenFactor;
					curVel[1] = curVel[1] - curVel[1] * dampenFactor;

					// Add the accumulated travelled distance.
					var angle = Math.acos(otherDir[0] * prevDir[0] + otherDir[1] * prevDir[1]);
					obj.degreesAccum = obj.degreesAccum + angle;

					var collideDist = distance(curPos, planetPos);
					if (collideDist < obj.radius + planet.radius) {
						thrownObjects = [];

						gameState = GameState.ORBIT_PLACING;

						// TODO: Some sweet effect here.
						thrownObject = {
							radius : 7,
							pos : [ 0, 0 ],
							vel : [ 0, 0 ],
							degreesAccum : 0
						};
					}
				}
			}

			function fadeIn(element, completeBlock) {
				var interval = window.setInterval(function() {
 					var opacity = parseFloat(element.style.opacity);
 					var newOpacity = (opacity + 0.05).toFixed(2);
 					element.style.opacity = newOpacity;

 					if (newOpacity >= 1.0) {
 						window.clearInterval(interval);

 						if (completeBlock) {
 							completeBlock();
 						}
 					}
 				}, 33);
			}

			function fadeOut(element, completeBlock) {
				var interval = window.setInterval(function() {
 					var opacity = parseFloat(element.style.opacity);
 					var newOpacity = (opacity - 0.05).toFixed(2);
 					element.style.opacity = newOpacity;

 					if (newOpacity <= 0.0) {
 						window.clearInterval(interval);
 						if (completeBlock) {
 							completeBlock();
 						}
 					}
 				}, 33);
			}

			function draw(context) {
				var canvas = document.getElementById('gameBoard');
				var width = window.innerWidth;
 				var height = window.innerHeight;
				context.clearRect(0, 0, width, height);

				if (gameState == GameState.ORBIT_WINDUP) {
					context.strokeStyle = "#ffffff";

					var dir = direction(mousePos, mouseDownPos);
					var dist = Math.min(distance(mousePos, mouseDownPos), maxLength);
					var endPos = [ mouseDownPos[0] + dir[0] * dist, mouseDownPos[1] + dir[1] * dist ];

					context.lineWidth = 3;
					context.moveTo(mouseDownPos[0], mouseDownPos[1]);
					context.lineTo(endPos[0], endPos[1]);
					context.stroke();
				}

				context.fillStyle = "#ec4343";
				context.strokeStyle = "#00bff3";

				context.lineWidth = 2;
				if (thrownObject) {
					drawOrbitPosition(context, thrownObject.pos, thrownObject.radius);
				}

				for (var i = 0; i < thrownObjects.length; ++i) {
					var obj = thrownObjects[i];
					drawOrbitPosition(context, obj.pos, obj.radius);
				}

				if (planet.img) {
					var planetX = planet.pos[0] - planet.img.width / 2;
					var planetY = planet.pos[1] - planet.img.height / 2;
					context.drawImage(planet.img, planetX, planetY);

					context.fillStyle = "#222222";
					context.font = "45px Impact";

					if (thrownObjects.length) {
						var revolutions =  thrownObjects[0].degreesAccum / (2 * Math.PI);
						context.textAlign = 'center';
						context.textBaseline = 'middle';
  						context.fillText(Math.floor(revolutions).toFixed(0), planet.pos[0], planet.pos[1]);
					}
				}
			}

			function handleMouseMove(mouseMoveEvent) {
				var x, y;
				if (mouseMoveEvent.layerX || mouseMoveEvent.layerX == 0) {
					x = mouseMoveEvent.layerX;
					y = mouseMoveEvent.layerY;
				}
				else if (mouseMoveEvent.offsetX || mouseMoveEvent.offsetX == 0) {
				    x = ev.offsetX;
				    y = ev.offsetY;
				}
				mousePos = [ x, y ];
			}

			function handleMouseDown() {
				if (gameState == GameState.ORBIT_PLACING) {
					gameState = GameState.ORBIT_WINDUP;
					mouseDownPos = mousePos;
				}
			}

			function handleMouseUp() {
				var lengthScale = 0.05;
				if (gameState == GameState.ORBIT_WINDUP) {
					gameState = GameState.ORBIT_ACTIVE;

					var dir = direction(mousePos, mouseDownPos);
					var len = Math.min(distance(mousePos, mouseDownPos) * lengthScale, maxLength);

					releasePos = thrownObject.pos;

					thrownObject.vel = [ dir[0] * len, dir[1] * len ];
					mouseDownPos = [ 0, 0 ];

					thrownObjects = [ thrownObject ];
				}
			}

			function handleWindowResize() {
				var canvas = document.getElementById('gameBoard');
				canvas.width = window.innerWidth - 12;
 				canvas.height = window.innerHeight - 12;
			}

			function initializeGameVars() {
				gameState = GameState.ORBIT_PLACING;
				mousePos = [ -20, -20 ];
				mouseDownPos = [ 0, 0 ];
				maxLength = 80;
				maxDistance = 2000;
				iterations = 0;

				// Initialize the game objects.
				thrownObject = {
					radius : 7,
					pos : [ 0, 0 ],
					vel : [ 0, 0 ],
					degreesAccum : 0
				};
				thrownObjects =[];
			}

			function startGame() {
				var canvas = document.getElementById('gameBoard');
				canvas.width = window.innerWidth - 12;
 				canvas.height = window.innerHeight - 12;
 				fadeIn(canvas);

 				var ins1 = document.getElementById('instructionsLabel1');
 				var ins2 = document.getElementById('instructionsLabel2');
 				var titleLabel = document.getElementById('titleLabel');

 				var instructionsStart = 1200;
 				window.setTimeout(function() { fadeIn(titleLabel); }, 400);
 				window.setTimeout(function() { fadeIn(ins1); }, instructionsStart);
 				window.setTimeout(function() { fadeIn(ins2); }, instructionsStart + 1000);
 				window.setTimeout(function() { fadeOut(ins1); }, instructionsStart + 1200);
 				window.setTimeout(function() { fadeOut(ins2); }, instructionsStart + 2000);
 				window.setTimeout(function() { fadeOut(titleLabel); }, instructionsStart + 2500);

 				initializeGameVars();
 				planet.pos = [ canvas.width / 2, canvas.height / 2 ];

 				// Load the planet image.
 				var planetImage = new Image();
 				planetImage.src = "sun.png";
 				planetImage.onload = function() {
 					planet.img = planetImage;
 				}

				var context = canvas.getContext('2d');
				
				canvas.addEventListener('mouseup', handleMouseUp, false);
				canvas.addEventListener('mousemove', handleMouseMove, false);
				canvas.addEventListener('mousedown', handleMouseDown, false);
				window.onresize = handleWindowResize;

				var gameLoop = function() {
					update();
					draw(context);
				}

				var animFrameLoop = function() {
					gameLoop();
					requestAnimFrame(animFrameLoop)
				}
				requestAnimFrame(animFrameLoop);
			}
		</script>
	</head>
	<body onload="startGame();" bgcolor="#222222" style="margin-left:0px; margin-top:0px;">
		<div style="font-family:Helvetica; align:center;">
			<div id="titleLabel" style="position:absolute; top:0px; left:0px; color:#dddddd; font-size:80px; font-family:Impact; width:100%; text-align:center; opacity:0;">orbit</div>
			<div id="instructionsLabel1" style="font-family:HelveticaNeue-Light; position:absolute; top:100px; left:0px; color:#dddddd; font-size:40px; width:100%; text-align:center; height:40px; opacity:0;">put your planet in orbit</div>
			<div id="instructionsLabel2" style="font-family:HelveticaNeue-Light; position:absolute; top:120px; left:0px; color:#dddddd; font-size:40px; width:100%; text-align:center; height:40px; opacity:0;">keep it there as long as you can</div>
			<!--<div id="scoreContainer" style="position:absolute; top:0px; left:0px; opacity:0; text-align:right; width:100%;">
				<div id="highScore" style="color:#dddddd; font-size:105px; font-family:Impact; width:70px;"></div>
				<div id="highScoreLabel" style="font-size:12; font-weight:condensed; top:50px; color:#dddddd; background-color:#222222; text-align:center; width:70px; height:25px;">Revolutions</div>
				<div id="planetsLeft" style="color:white; font-size:105px; font-family:Impact;"></div>
			</div>-->
			<canvas id="gameBoard" width="500" height="500" style="border-width:2px; border-color:white; opacity:0;"></canvas>
		</div>
	</body>
</html>