<html>
	<head>
		<title>orbit</title>
		<script>
			var requestAnimFrame = (function(){
			      return  window.requestAnimationFrame       || 
			              window.webkitRequestAnimationFrame || 
			              window.mozRequestAnimationFrame    || 
			              window.oRequestAnimationFrame      || 
			              window.msRequestAnimationFrame     || 
			              function(callback) {
			              		window.setTimeout(callback, 1000 / 60);
			              };
			})();

			// Array Remove - By John Resig (MIT Licensed)
			Array.prototype.remove = function(from, to) {
				var rest = this.slice((to || from) + 1 || this.length);
				this.length = from < 0 ? this.length + from : from;
				return this.push.apply(this, rest);
			};

			var GameState = {
				ORBIT_PLACING : 1,
				ORBIT_WINDUP : 2,
				ORBIT_ACTIVE : 3,
				ORBIT_FINISHED : 4
			};

			// Game variables.
			var gameState = GameState.ORBIT_PLACING;
			var mousePos = [ -20, -20 ];
			var mouseDownPos = [ 0, 0 ];
			var maxLength = 80;
			var maxDistance = 2000;
			var iterations = 0;

			var startTime;

			// Initialize the game objects.
			var thrownObject = {
				radius : 7,
				pos : [ 0, 0 ],
				vel : [ 0, 0 ],
				active : true
			};

			var thrownObjects = [];

			var planet = {
				radius : 50,
				pos : [ 0, 0 ],
				img : null
			};

			function drawOrbitPosition(context, pos, radius) {
				context.fillStyle = "#ec4343";
				context.strokeStyle = "#00bff3";

				context.beginPath();
				context.arc(pos[0], pos[1], radius, 0, 2 * Math.PI, false);
				context.fill();
				context.stroke();
			}

			function length(vec) {
				return Math.sqrt(vec[0] * vec[0] + vec[1] * vec[1]);
			}

			function distance(vec1, vec2) {
				var x = vec2[0] - vec1[0];
				var y = vec2[1] - vec1[1];
				return length([x, y]);
			}
			function normalize(vec) {
				var len = length(vec);
				return [ vec[0] / len, vec[1] / len ];
			}

			function direction(vec1, vec2) {
				var x = vec2[0] - vec1[0];
				var y = vec2[1] - vec1[1];
				return normalize([ x, y ]);
			}

			function update() {
				if (gameState == GameState.ORBIT_PLACING) {
					thrownObject.pos = mousePos;
				}
				else if (gameState == GameState.ORBIT_WINDUP) {
					thrownObject.pos = mouseDownPos;
				}

				var activeObjects = 0;

				for (var i = 0; i < thrownObjects.length; ++i) {
					var obj = thrownObjects[i];
					if (obj.active == false) {
						continue;
					}

					activeObjects++;

					var curPos = obj.pos;
					var curVel = obj.vel;
					var planetPos = planet.pos;

					var dist = distance(curPos, planetPos);
					var dir = direction(curPos, planetPos);
					var force = 3000.0 / ((dist * dist) + 500.0);

					if (dist > maxDistance) {
						obj.active = false;
					}

					curVel[0] += dir[0] * force;
					curVel[1] += dir[1] * force;

					curPos[0] += curVel[0];
					curPos[1] += curVel[1];

					var collideDist = distance(curPos, planetPos);
					if (collideDist < obj.radius + planet.radius) {
						obj.active = false;
						// TODO: Some sweet effect here.
					}

					if (obj.active) {
						for (var j = 0; j < thrownObjects.length; ++j) {
							var obj2 = thrownObjects[j];
							if (obj2.active && obj != obj2) {
								var collideDist = distance(obj.pos, obj2.pos);
								if (collideDist < obj.radius + obj2.radius) {
									obj.active = false;
									obj2.active = false;
								}
							}
						}
					}
				}

				var score = document.getElementById('highScore');
				if (iterations > 5) {
					score.innerHTML = activeObjects.toFixed(0);
					iterations = 0;
				}
				iterations++;
			}

			function draw(context) {
				var canvas = document.getElementById('gameBoard');
				var width = window.innerWidth;
 				var height = window.innerHeight;
				context.clearRect(0, 0, width, height);

				if (gameState == GameState.ORBIT_WINDUP) {
					context.strokeStyle = "#ffffff";

					var dir = direction(mousePos, mouseDownPos);
					var dist = Math.min(distance(mousePos, mouseDownPos), maxLength);
					var endPos = [ mouseDownPos[0] + dir[0] * dist, mouseDownPos[1] + dir[1] * dist ];

					context.lineWidth = 3;
					context.moveTo(mouseDownPos[0], mouseDownPos[1]);
					context.lineTo(endPos[0], endPos[1]);
					context.stroke();
				}

				context.fillStyle = "#ec4343";
				context.strokeStyle = "#00bff3";

				context.lineWidth = 2;
				if (thrownObject) {
					drawOrbitPosition(context, thrownObject.pos, thrownObject.radius);
				}

				for (var i = 0; i < thrownObjects.length; ++i) {
					var obj = thrownObjects[i];
					if (obj.active) {
						drawOrbitPosition(context, obj.pos, obj.radius);
					}
				}

				if (planet.img) {
					context.drawImage(planet.img, planet.pos[0] - planet.img.width / 2, planet.pos[1] - planet.img.height / 2);
				}
			}

			function handleMouseMove(mouseMoveEvent) {
				var x, y;
				if (mouseMoveEvent.layerX || mouseMoveEvent.layerX == 0) {
					x = mouseMoveEvent.layerX;
					y = mouseMoveEvent.layerY;
				}
				else if (mouseMoveEvent.offsetX || mouseMoveEvent.offsetX == 0) {
				    x = ev.offsetX;
				    y = ev.offsetY;
				}
				mousePos = [ x, y ];
			}

			function handleMouseDown() {
				if (gameState == GameState.ORBIT_PLACING) {
					gameState = GameState.ORBIT_WINDUP;
					mouseDownPos = mousePos;
				}
			}

			function handleMouseUp() {
				var lengthScale = 0.05;
				if (gameState == GameState.ORBIT_WINDUP) {
					gameState = GameState.ORBIT_PLACING;

					var dir = direction(mousePos, mouseDownPos);
					var len = Math.min(distance(mousePos, mouseDownPos) * lengthScale, maxLength);
					thrownObject.vel = [ dir[0] * len, dir[1] * len ];
					mouseDownPos = [ 0, 0 ];

					thrownObjects.push(thrownObject);
					thrownObject = {
						radius : 7,
						pos : [ 0, 0 ],
						vel : [ 0, 0 ],
						active : true
					};

					startTime = new Date().getTime();
				}
			}

			function handleWindowResize() {
				var canvas = document.getElementById('gameBoard');
				canvas.width = window.innerWidth - 13;
 				canvas.height = window.innerHeight - 13;
			}

			function startGame() {
				var canvas = document.getElementById('gameBoard');
				canvas.width = window.innerWidth - 13;
 				canvas.height = window.innerHeight - 13;

 				planet.pos = [ canvas.width / 2 - planet.radius / 2, canvas.height / 2 - planet.radius / 2 ];

 				// Load the planet image.
 				var planetImage = new Image();
 				planetImage.src = "sun.png";
 				planetImage.onload = function() {
 					planet.img = planetImage;
 				}

				var context = canvas.getContext('2d');
				
				canvas.addEventListener('mousemove', handleMouseMove, false);
				canvas.addEventListener('mousedown', handleMouseDown, false);
				canvas.addEventListener('mouseup', handleMouseUp, false);
				window.onresize = handleWindowResize;

				var gameLoop = function() {
					update();
					draw(context);
				}

				var animFrameLoop = function() {
					gameLoop();
					requestAnimFrame(animFrameLoop)
				}
				requestAnimFrame(animFrameLoop);
			}
		</script>
	</head>
	<body onload="startGame();" bgcolor="#1b168d" style="margin-left:0px; margin-top:0px;">
		<div style="font-family:Helvetica; align:center;">
			<div id="highScore" style="position:absolute; left:15px; color:white; font-size:55px; font-family:Impact;"></div>
			<!--<div id="highScoreLabel" style="width:90px; position:absolute; color:#ec4343; float:left; font-size:14; font-weight:condensed; top:65px; background-color:#ffffff; text-align:center;">High Today</div>-->
			<canvas id="gameBoard" width="500" height="500" style="border-width:2px; border-color:white;"></canvas>
		</div>
	</body>
</html>